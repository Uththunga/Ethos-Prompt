rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // User settings - users can only access their own settings
    match /userSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // RAG documents - users can only access their own
    match /rag_documents/{documentId} {
      allow read, update, delete: if request.auth != null &&
        request.auth.uid == resource.data.uploadedBy;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.uploadedBy;
    }

    // Rate limiting collection - users can manage their own rate limits
    match /rate_limits/{limitId} {
      // Users can only read their own rate limit documents
      allow read: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      // Users can create rate limits for themselves
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
      // Users can update/delete their own rate limits
      allow update, delete: if request.auth != null &&
        request.auth.uid == resource.data.userId;
    }

    // Embeddings collection - vector embeddings for RAG
    match /embeddings/{embeddingId} {
      // Only authenticated users can read their own embeddings
      allow read: if request.auth != null &&
                     request.auth.uid == resource.data.userId;

      // Only system (Cloud Functions) can write embeddings
      allow write: if false;
    }

    // Conversations collection - user-owned chat threads
    match /conversations/{conversationId} {
      // Helper functions
      function isAuthenticated() { return request.auth != null; }
      function isOwner() { return isAuthenticated() && request.auth.uid == resource.data.userId; }
      function isOwnerOnCreate() { return isAuthenticated() && request.auth.uid == request.resource.data.userId; }
      function isNotDeleted() { return !('deletedAt' in resource.data) || resource.data.deletedAt == null; }

      // Top-level conversation document rules
      allow read: if isOwner() && isNotDeleted();
      allow create: if isOwnerOnCreate();
      allow update: if isOwner();
      allow delete: if isOwner();

      // Messages subcollection
      match /messages/{messageId} {
        function parentUser() {
          return get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId;
        }
        function isParentOwner() {
          return isAuthenticated() && request.auth.uid == parentUser();
        }
        function isValidRole() {
          return request.resource.data.role in ['user', 'assistant', 'system'];
        }
        function contentWithinLimit() {
          return request.resource.data.content is string &&
                 request.resource.data.content.size() > 0 &&
                 request.resource.data.content.size() <= 10000;
        }
        function conversationMatches() {
          return !('conversationId' in request.resource.data) ||
                 request.resource.data.conversationId == conversationId;
        }

        allow read: if isParentOwner();
        allow create: if isParentOwner() &&
                       request.resource.data.userId == parentUser() &&
                       isValidRole() &&
                       contentWithinLimit() &&
                       conversationMatches();
        allow update: if isParentOwner();
        allow delete: if isParentOwner();
      }
    }

    // Help Articles - publicly readable, admin writable
    match /helpArticles/{articleId} {
      // Helper functions
      function isAuthenticated() {
        return request.auth != null;
      }

      function isAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      function isViewCountIncrement() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']) &&
               request.resource.data.views == resource.data.views + 1;
      }

      function isHelpfulIncrement() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['helpful']) &&
               request.resource.data.helpful == resource.data.helpful + 1;
      }

      function isRatingUpdate() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating']) &&
               request.resource.data.rating >= 0 &&
               request.resource.data.rating <= 5;
      }

      // Anyone can read help articles
      allow read: if true;

      // Only admins can create, update, or delete articles
      allow create, delete: if isAdmin();

      // Allow admins to update, or allow incrementing view count/helpful/rating
      allow update: if isAdmin() ||
                       isViewCountIncrement() ||
                       isHelpfulIncrement() ||
                       isRatingUpdate();

      // Version subcollection - admin only
      match /versions/{versionId} {
        allow read: if isAdmin();
        allow write: if isAdmin();
      }
    }

    // Onboarding state - per-user guided tour progress
    match /onboarding/{userId} {
      // Users can read and manage their own onboarding document
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Onboarding analytics events - write-only from the client
    match /onboardingEvents/{eventId} {
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
      allow read, update, delete: if false;
    }

    // Marketing and Admin Collections - Server-side only access
    match /contacts/{contactId} {
      allow read, write: if false;
    }

    match /contact_activities/{activityId} {
      allow read, write: if false;
    }

    match /email_templates/{templateId} {
      allow read, write: if false;
    }

    match /email_sequences/{sequenceId} {
      allow read, write: if false;
    }

    match /email_jobs/{jobId} {
      allow read, write: if false;
    }

    match /email_events/{eventId} {
      allow read, write: if false;
    }

    match /user_roles/{userId} {
      allow read, write: if false;
    }

  }
}
