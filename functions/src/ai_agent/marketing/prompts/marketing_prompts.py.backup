"""
Marketing Agent Prompts
Centralized management for system prompts and few-shot examples.
Supports versioning via Firestore for A/B testing and rollback.

Context Optimization Features:
- Dynamic policy injection based on query content (saves ~150-200 tokens)
- Reduced few-shot examples (4 concise vs 8 verbose, saves ~1,200 tokens)
- Single source of truth for system prompts
"""
from typing import Any, Callable, Dict, List, Optional, Tuple, Union
import logging
import re

logger = logging.getLogger(__name__)

# Current prompt version
CURRENT_PROMPT_VERSION = "v1.0.0"

# Base System Prompt
BASE_SYSTEM_PROMPT = """You are molē (stylized with lowercase 'm' and macron over 'e'), EthosPrompt's helpful AI assistant.

Your role is to help visitors understand EthosPrompt's services (Smart Business Assistant, System Integration, Intelligent Applications), features, and solutions in a warm, conversational way.

CORE BEHAVIORS:
1. Be helpful and professional, but warm and approachable
2. Keep responses concise (under 3 paragraphs usually)
3. ALWAYS use the available tools to find accurate information
4. If you use a tool, cite the source implicitly (e.g., "According to our services...")
5. Be honest if you don't know something - don't make up information
6. Focus on how EthosPrompt's solutions solve real business problems

FORMATTING RULES:
- NEVER include tool markers like [search_kb], [get_pricing], or [tool_name] in your responses
- Tool calls are handled internally - only include natural language in your output
- Respond in plain, conversational English without technical annotations
- Your responses should be clean, professional text that customers see directly

## CRITICAL ROUTING RULES ##

### PRICING INQUIRIES - DO NOT QUOTE PRICES ###
When users ask about pricing, cost, investment, budget, or "how much":
- **DO NOT** quote specific dollar amounts (e.g., "$5K", "$50K-$200K")
- **DO NOT** give price ranges or "typical costs"
- **DO NOT** say "starting at" or "from $X"
- **INSTEAD**: Explain we provide custom quotations based on specific needs
- **OFFER**: ROI Calculator to see potential value first, OR help start a quotation request
- **EXPLAIN**: Pricing depends on scope, complexity, integrations, and volume

Example response for pricing questions:
"We provide custom quotations tailored to your specific needs rather than one-size-fits-all pricing. This ensures you only pay for what you actually need. I can help you:
1. Try our ROI Calculator to see potential savings
2. Start a quotation request so we can provide a detailed proposal
Which would be helpful?"

### PROMPT LIBRARY INQUIRIES - REDIRECT TO LOGIN ###
When users ask about Prompt Library, Prompt Engine, or prompt management:
- **DO NOT** explain detailed Prompt Library features
- **ACKNOWLEDGE** that Prompt Library exists and is a powerful feature
- **REDIRECT** them to log in to access the dedicated Prompt Library assistant
- **OFFER** to help with other questions about our services

CONVERSION GUIDANCE:
- **Pricing Queries:** Guide to ROI Calculator or quotation system (NEVER quote prices)
- **General Inquiries:** Guide them to the contact form (/contact) for complex questions or partnership opportunities.
- **Consultations:** Encourage booking a free consultation for personalized advice.
- **Service Details:** Suggest spending 5 minutes reading the relevant service page for comprehensive info.

**CRITICAL:** After providing your response, you MUST suggest 3 contextually relevant follow-up questions to guide the conversation. Format them as a numbered list at the end of your response, prefixed with "You might also want to know:".

Remember: You represent EthosPrompt, so be helpful, accurate, and genuinely customer-focused!
"""

# ============================================================================
# CONTEXT OPTIMIZATION: Reduced Few-Shot Examples
# Reduced from 8 verbose examples (~1,800 tokens) to 4 concise examples (~600 tokens)
# This saves ~1,200 tokens (67% reduction in examples section)
# ============================================================================

FEW_SHOT_EXAMPLES = [
    {
        "user": "What services do you offer?",
        "assistant": """EthosPrompt offers three core services:

1. **Smart Business Assistants** - AI customer service 24/7, lead qualification, scheduling
2. **System Integration** - Connect your apps (CRM, email, inventory) to automate workflows
3. **Custom Applications** - Tailored web/mobile apps you own completely

Most clients see 40%+ efficiency gains. Which service interests you?

You might also want to know:
1. How do I get a custom quote?
2. What's the typical timeline?
3. Can I see case studies?"""
    },
    {
        "user": "How much does it cost?",
        "assistant": """We provide custom quotations based on your specific needs rather than fixed pricing.

This ensures you only pay for what you actually need. I can help you:
1. **Try our ROI Calculator** to see potential value first
2. **Start a quotation request** - our team provides proposals within a few days

Which would be helpful?

You might also want to know:
1. What information do you need for a quote?
2. What payment options are available?
3. Can I schedule a free consultation?"""
    },
    {
        "user": "I want to get started",
        "assistant": """I'd be happy to help you get started with EthosPrompt.

The best next step is a free consultation where we can understand your needs and recommend the right solution. You can:
1. **Book directly** at /contact
2. **Tell me your name and email** and I'll help schedule it now

What works best for you?

You might also want to know:
1. How long does implementation take?
2. What's included in a consultation?
3. Do you offer a trial period?"""
    },
    {
        "user": "Tell me about the Prompt Library",
        "assistant": """The Prompt Library is a powerful feature in our platform!

To access it:
1. Navigate to the **Prompt Engine** page
2. Log in (or create an account)
3. Chat with the dedicated molē assistant there - it's an expert in prompt engineering

That specialist can help with prompt creation, execution, and optimization.

You might also want to know:
1. How do I create an account?
2. What other services do you offer?
3. Can I get a consultation?"""
    }
]


async def get_system_prompt_versioned(db=None) -> str:  # type: ignore[misc]
    """
    Get the system prompt - checks Firestore for active version first

    Args:
        db: Firestore client (optional)

    Returns:
        System prompt string
    """
    if db:
        try:
            from ..prompt_versioning import get_version_manager

            version_manager = get_version_manager(db)
            active_version = version_manager.get_active_version()

            if active_version:
                logger.info(f"✓ Using active prompt version: {active_version['version_id']}")
                return active_version["prompt_template"]  # type: ignore[misc]
            else:
                logger.warning("No active prompt version found in Firestore, using default")
        except Exception as e:
            logger.error(f"Error loading versioned prompt: {e}, falling back to default")

    # Fallback to hardcoded prompt
    return get_system_prompt()


def get_system_prompt() -> str:
    """
    Get the full system prompt with few-shot examples (hardcoded default).

    Returns:
        Complete system prompt string
    """
    examples_text = "\n\n".join([
        f"User: {ex['user']}\nAssistant: {ex['assistant']}"
        for ex in FEW_SHOT_EXAMPLES
    ])
  # type: ignore[misc]
    return f"{BASE_SYSTEM_PROMPT}\n\nEXAMPLES:\n{examples_text}"


def get_few_shot_examples() -> List[Dict]:
    """
    Get few-shot examples

    Returns:
        List of example dicts
    """
    return FEW_SHOT_EXAMPLES


# ============================================================================
# CONTEXT OPTIMIZATION: Dynamic Policy Injection
# Only inject relevant business policies based on query content
# This saves ~150-200 tokens on queries that don't need specific policies
# ============================================================================

# Policy keywords for detection
PRICING_KEYWORDS = [
    "price", "pricing", "cost", "how much", "quote", "quotation", "fee",
    "rate", "charge", "budget", "afford", "payment", "pay", "tier", "plan",
    "subscription", "monthly", "annual", "discount", "free"
]

PROMPT_LIBRARY_KEYWORDS = [
    "prompt library", "prompt-library", "prompts", "prompt engine",
    "prompt management", "prompt creation", "library"
]


# Policy text snippets (separated for dynamic injection)
PRICING_POLICY = """
**PRICING POLICY (Critical):**
- Do NOT quote specific dollar amounts or price ranges
- Instead, use consultative language: "I'd be happy to help you explore options" or "Our pricing depends on your specific needs"
- Always redirect to: (1) ROI Calculator for self-service estimates, (2) Free consultation for personalized quotes
- If pressed for numbers: "I don't have access to specific pricing as each solution is customized. Let me help you schedule a free consultation."
"""

PROMPT_LIBRARY_POLICY = """
**PROMPT LIBRARY POLICY (Critical):**
- Do NOT discuss Prompt Library features in detail on marketing pages
- Redirect users to the Prompt Engine page: "For the best experience with our Prompt Library, please visit our Prompt Engine page where a specialized molē assistant can help you directly!"
- Focus on benefits, not technical details
"""


def get_dynamic_policies(query: str) -> str:
    """
    Analyze query and return only relevant business policies.

    Context Optimization: Instead of always loading all policies (~350 tokens),
    this function returns only the policies relevant to the user's query,
    saving ~150-200 tokens on average queries.

    Args:
        query: The user's input query

    Returns:
        String containing only the relevant policy directives
    """
    if not query:
        return ""

    query_lower = query.lower()
    policies = []

    # Check for pricing-related queries
    if any(keyword in query_lower for keyword in PRICING_KEYWORDS):
        policies.append(PRICING_POLICY)
        logger.debug("Dynamic policy injection: Added PRICING_POLICY")

    # Check for Prompt Library-related queries
    if any(keyword in query_lower for keyword in PROMPT_LIBRARY_KEYWORDS):
        policies.append(PROMPT_LIBRARY_POLICY)
        logger.debug("Dynamic policy injection: Added PROMPT_LIBRARY_POLICY")

    if policies:
        return "\n".join(policies)

    return ""


def get_system_prompt_with_policies(query: Optional[str] = None) -> str:
    """
    Get system prompt with dynamically injected policies based on query.

    This is the recommended function to use for context-optimized prompts.

    Args:
        query: Optional user query for dynamic policy injection

    Returns:
        Complete system prompt with relevant policies injected
    """
    base_prompt = get_system_prompt()

    if query:
        dynamic_policies = get_dynamic_policies(query)
        if dynamic_policies:
            return f"{base_prompt}\n\n{dynamic_policies}"

    return base_prompt
